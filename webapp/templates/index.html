{% extends "base.html" %}

{% block content %}
<h2>Сертификаты ЭП</h2>

<!-- Форма фильтрации -->
<form method="GET" class="row g-3 mb-4">
  <div class="col-md-4">
    <input type="text" name="search" class="form-control" placeholder="Поиск по ФИО или email" value="{{ search }}">
  </div>
  <div class="col-md-3">
    <select name="status" class="form-control">
      <option value="">Все статусы</option>
      <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Активные</option>
      <option value="warning" {% if status_filter == 'warning' %}selected{% endif %}>Скоро истекают</option>
      <option value="expired" {% if status_filter == 'expired' %}selected{% endif %}>Просроченные</option>
    </select>
  </div>
  <div class="col-md-2">
    <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
  </div>
  <div class="col-md-2">
    <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
  </div>
  <div class="col-md-1">
    <button type="submit" class="btn btn-primary w-100">
      <i class="fa-solid fa-magnifying-glass" style="color: #ffffff;"></i>
    </button>
  </div>
</form>

<a href="{{ url_for('add') }}" class="btn btn-success mb-3">Добавить сертификат</a>

<!-- Таблица -->
<table class="table table-striped">
  <thead>
    <tr>
      <th>Сотрудник</th>
      <th>Серийный №</th>
      <th>Срок действия</th>
      <th>Статус</th>
      <th>Действия</th>
    </tr>
  </thead>
  <tbody>
    {% for c in certificates %}
    <tr class="{{ c.status_class }}">
      <td>
        {{ c.full_name }}<br>
        <small>{{ c.position }} | {{ c.department }}</small>
      </td>
      <td><code>{{ c.serial_number }}</code></td>
      <td>
        {{ c.valid_from.strftime('%d.%m') }} — {{ c.valid_to.strftime('%d.%m.%Y') }}
      </td>
      <td>
        <span class="badge bg-{{ 'danger' if c.status_class == 'expired' else 'warning text-dark' if c.status_class == 'warning' else 'success' }}">
          {{ c.status_label }}
        </span>
      </td>
      <td>
        {% if session.role == 'admin' %}
        <a href="{{ url_for('view', cert_id=c.id) }}" class="btn btn-sm btn-info" title="Просмотр">
          <i class="fa-regular fa-eye" style="color: #ffffff;"></i>
        </a>
        <a href="{{ url_for('edit', cert_id=c.id) }}" class="btn btn-sm btn-warning" title="Редактировать">
          <i class="fa-regular fa-pen-to-square" style="color: #ffffff;"></i>
        </a>
        <a href="{{ url_for('delete', cert_id=c.id) }}" class="btn btn-sm btn-danger" title="Удалить" onclick="return confirm('Удалить сертификат?')">
          <i class="fa-regular fa-trash-can" style="color: #ffffff;"></i>
        </a>

        {% else %}
        <!-- Обычный пользователь: неактивные кнопки (но видны) -->
        <button type="button" class="btn btn-sm btn-info" disabled>
          <i class="fa-regular fa-eye" style="color: #ffffff;"></i>
        </button>
        <button type="button" class="btn btn-sm btn-warning" disabled>
          <i class="fa-regular fa-pen-to-square" style="color: #ffffff;"></i>
        </button>
        <button type="button" class="btn btn-sm btn-danger" disabled>
          <i class="fa-regular fa-trash-can" style="color: #ffffff;"></i>
        </button>
  
        {% endif %}
      </td>
    </tr>
    {% else %}
    <tr>
      <td colspan="5" class="text-center text-muted">Сертификаты не найдены</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}